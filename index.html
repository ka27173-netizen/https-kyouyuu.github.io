<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>情報共有特設サイト</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* カスタムスタイル */
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f8fafc; /* Tailwindのgray-50 */
        }
        /* 横スクロールコンテナのスクロールバーを非表示にし、スナップを効かせる */
        .calendar-scroll-container {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
            scroll-snap-type: x mandatory;
        }
        .calendar-scroll-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, and Opera */
        }
        .calendar-month {
            scroll-snap-align: center;
        }
        /* イベント用の基本スタイル */
        .event {
            font-size: 0.75rem; /* 12px */
            padding: 2px 4px;
            margin-top: 4px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border: 1px solid transparent;
            cursor: pointer;
        }
        /* 通常の予定 */
        .event-normal {
            background-color: #e0e7ff; /* indigo-100 */
            color: #3730a3; /* indigo-800 */
            border-color: #c7d2fe; /* indigo-200 */
        }
        /* 土曜日の予定 */
        .event-saturday {
            background-color: #cffafe; /* cyan-100 */
            color: #0e7490; /* cyan-700 */
            border-color: #a5f3fc; /* cyan-200 */
        }
        /* 優先度高の予定（オレンジ） */
        .event-high-priority {
            background-color: #fffbeb; /* amber-50 */
            color: #b45309; /* amber-700 */
            border-color: #fde68a; /* amber-200 */
        }
        /* 大事な予定（黒） */
        .event-important {
            background-color: #1f2937; /* gray-800 */
            color: #f9fafb; /* gray-50 */
        }
        /* Webコンテストの予定（緑） */
        .event-contest {
            background-color: #dcfce7; /* green-100 */
            color: #166534; /* green-800 */
            border-color: #bbf7d0; /* green-200 */
        }
        /* 過去の日のイベント */
        .past-day .event-normal, .past-day .event-saturday, .past-day .event-high-priority, .past-day .event-contest {
            background-color: #e5e7eb; /* gray-200 */
            color: #6b7280; /* gray-500 */
            border-color: #d1d5db; /* gray-300 */
        }
         .past-day .event-important {
            background-color: #6b7280; /* gray-500 */
            color: #d1d5db; /* gray-300 */
        }
        /* Modal styles */
        #event-modal, #event-modal-backdrop {
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
        }
        #event-modal.hidden, #event-modal-backdrop.hidden {
            opacity: 0;
            visibility: hidden;
        }
        /* ToDoリストの完了済みタスク */
        .completed > div > span {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }
    </style>
</head>
<body class="text-gray-800 pt-16">

    <header class="bg-white shadow-md fixed top-0 left-0 right-0 z-10">
        <div class="container mx-auto px-4 md:px-8 max-w-7xl">
            <nav class="flex justify-between items-center h-16">
                <div class="text-xl font-bold text-indigo-600">
                    情報共有ページ
                </div>
                <div class="space-x-4 md:space-x-8">
                    <a href="#notifications" class="text-gray-600 hover:text-indigo-600 font-medium transition-colors">連絡事項</a>
                    <a href="#todo" class="text-gray-600 hover:text-indigo-600 font-medium transition-colors">ToDo</a>
                    <a href="#calendar" class="text-gray-600 hover:text-indigo-600 font-medium transition-colors">カレンダー</a>
                    <a href="#links" class="text-gray-600 hover:text-indigo-600 font-medium transition-colors">リンク</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- 1. 連絡したいこと -->
        <section id="notifications" class="mb-8 md:mb-12 pt-4">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-indigo-600"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path></svg>
                連絡事項
            </h2>
            <div class="space-y-4">
                <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-yellow-400">
                    <p class="font-semibold text-gray-800">
                        【重要】<a href="https://jnk4.org/JAPIAS-DBx/WebContest/myPage/?p=x17xi80375jt" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline">今年度のスケジュール</a>
                        <span class="text-sm text-gray-600 font-normal ml-4">このページのパスワード 280075Wgq2</span>
                    </p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                    <p class="font-semibold text-gray-800">【重要】明日(10/13)web会議します</p>
                    <p class="text-sm text-gray-600 mt-1">四時ちょっと前にリンク投げるからそこから入ってね</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                    <p class="font-semibold text-gray-800">スライド・スライド原稿</p>
                    <p class="text-sm text-gray-600 mt-1">ぱぱっとと終わらせてHP改善したいです</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                    <p class="font-semibold text-gray-800">ファイル構成を変更します</p>
                    <p class="text-sm text-gray-600 mt-1">トップページをindex.htmlホームボタンを押して飛ぶトップページをhome.htmlにする予定です</p>
                </div>
            </div>
        </section>

        <!-- 1.5 ToDoリスト -->
        <section id="todo" class="mb-8 md:mb-12 pt-4">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-indigo-600"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                みんなのToDoリスト
            </h2>
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                <!-- Add Task Form -->
                <div class="space-y-4">
                    <input type="text" id="todo-input" placeholder="新しいタスクを入力..." class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div id="todo-assignee-group" class="border border-gray-300 rounded-md p-3 bg-white">
                            <label class="block text-sm font-medium text-gray-700 mb-2">担当者 (複数選択可)</label>
                            <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                <div><label class="flex items-center text-sm font-semibold"><input type="checkbox" id="all-assignees-checkbox" name="assignee" value="全員" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2">全員</label></div>
                                <div><label class="flex items-center text-sm"><input type="checkbox" name="assignee" value="モリヤ" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2 assignee-member">モリヤ</label></div>
                                <div><label class="flex items-center text-sm"><input type="checkbox" name="assignee" value="モリナガ" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2 assignee-member">モリナガ</label></div>
                                <div><label class="flex items-center text-sm"><input type="checkbox" name="assignee" value="シミズ" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2 assignee-member">シミズ</label></div>
                                <div><label class="flex items-center text-sm"><input type="checkbox" name="assignee" value="ウエダ" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2 assignee-member">ウエダ</label></div>
                                <div><label class="flex items-center text-sm"><input type="checkbox" name="assignee" value="スギタニ" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2 assignee-member">スギタニ</label></div>
                            </div>
                        </div>
                        <div>
                            <label for="todo-duedate" class="block text-sm font-medium text-gray-700 mb-1">期限</label>
                            <input type="date" id="todo-duedate" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                </div>
                <div class="flex justify-end mt-4 mb-6">
                    <button id="add-todo-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-indigo-700 transition-colors disabled:bg-indigo-400">追加</button>
                </div>
                
                <!-- Filter and Sort Controls -->
                <div class="flex flex-col md:flex-row gap-4 mb-4 p-4 bg-gray-50 rounded-lg border">
                    <div class="flex-1">
                        <label for="filter-assignee" class="block text-sm font-medium text-gray-700 mb-1">担当者で絞り込み</label>
                        <select id="filter-assignee" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white">
                            <option value="全員">全員</option>
                            <option>モリヤ</option>
                            <option>モリナガ</option>
                            <option>シミズ</option>
                            <option>ウエダ</option>
                            <option>スギタニ</option>
                            <option value="">担当者なし</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label for="sort-order" class="block text-sm font-medium text-gray-700 mb-1">並び替え</label>
                        <select id="sort-order" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white">
                            <option value="desc">作成日（新しい順）</option>
                            <option value="asc">作成日（古い順）</option>
                            <option value="dueDateAsc">期限が近い順</option>
                            <option value="dueDateDesc">期限が遠い順</option>
                        </select>
                    </div>
                </div>

                <!-- ToDo List -->
                <ul id="todo-list" class="space-y-3">
                    <!-- ToDoアイテムがここに動的に追加されます -->
                </ul>
            </div>
        </section>

        <!-- 2. カレンダー機能 -->
        <section id="calendar" class="mb-8 md:mb-12 pt-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-900 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-indigo-600"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line></svg>
                    カレンダー
                </h2>
                <div class="flex space-x-2">
                    <button id="prev-month" class="bg-indigo-600 text-white p-2 rounded-full shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform duration-150 active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"></path></svg>
                    </button>
                    <button id="next-month" class="bg-indigo-600 text-white p-2 rounded-full shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform duration-150 active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"></path></svg>
                    </button>
                </div>
            </div>
            
            <div id="calendar-scroll-container" class="calendar-scroll-container flex overflow-x-auto bg-white rounded-lg shadow-lg p-4 border border-gray-200">
                <!-- カレンダーがここに動的に生成されます -->
            </div>
        </section>

        <!-- 3. リンク一覧 -->
        <section id="links" class="pt-4">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-4 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-indigo-600"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg>
                リンク一覧
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- 僕らが作ってるHP -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 md:col-span-2 lg:col-span-3">
                    <h3 class="text-xl font-semibold text-indigo-700 mb-3">僕らが作ってるHP</h3>
                    <ul class="space-y-2">
                        <li><a href="file:///media/fuse/drivefs-ab8b5b3ed99213de0T5b56a773760e8/team_drives/%E4%B8%AD%E5%AD%A6%E6%8A%80%E8%A1%93%E7%A7%91%EF%BC%8BWeb%E3%82%B3%E3%83%B3%E3%83%86%E3%82%B9%E3%83%88/2025%E4%B8%AD2Web%E3%82%B3%E3%83%B3%E3%83%86%E3%82%B9%E3%83%88/25B07%E5%AE%88%E5%B1%8B%E5%B4%87%E7%A7%80/Actualperformance/top.html" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline flex items-center">トップページへ <span class="ml-1 text-xs">↗</span></a></li>
                    </ul>
                </div>
                <!-- ドキュメント -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-xl font-semibold text-blue-700 mb-3">ドキュメント</h3>
                    <ul class="space-y-2">
                        <li><a href="https://docs.google.com/document/d/1H4mZVyTgOn_uucbsnx7yhpFL7TuT84JS1XSJW9t7OLg/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline flex items-center">HPに書く内容<span class="ml-1 text-xs">↗</span></a></li>
                        <li><a href="https://docs.google.com/document/d/1-p__bNjTk10BAiD1SSX4QLftd-tIYb_sD8ZLX6EtorY/edit?tab=t.0" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline flex items-center">B07発表原稿シート<span class="ml-1 text-xs">↗</span></a></li>
                        <li><a href="https://docs.google.com/document/d/1NS0wGDr8qWzUCs2MoJXeUxpnOkt1ux-q8kaGvXJK6Jc/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline flex items-center">スライドの原稿　大まかな内容<span class="ml-1 text-xs">↗</span></a></li>
                    </ul>
                </div>
                <!-- スライド -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-xl font-semibold text-orange-600 mb-3">スライド</h3>
                    <ul class="space-y-2">
                        <li><a href="https://docs.google.com/presentation/d/1uk0yrDRlRE3riRvJ-Y7oLR537nh-eqgjAsGSlfsjHuE/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline flex items-center">B07発表スライド <span class="ml-1 text-xs">↗</span></a></li>
                    </ul>
                </div>
                <!-- スプレッドシート -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-xl font-semibold text-green-700 mb-3">スプレッドシート</h3>
                    <ul class="space-y-2">
                        <li><a href="https://docs.google.com/spreadsheets/d/1n4ZSHqn7fsye8tMvatf0orqJIvPSCgzB4tFCH4KZZLE/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline flex items-center">HPの改善点(回答)<span class="ml-1 text-xs">↗</span></a></li>
                        <li><a href="https://docs.google.com/spreadsheets/d/1L-cnJNl7g_j2r2yUi89ereJFS1VkGi0UHnSze8cYwcA/edit?usp=sharing" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline flex items-center">外国人に向けたアンケート(回答)<span class="ml-1 text-xs">↗</span></a></li>
                    </ul>
                </div>
                <!-- フォーム -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-xl font-semibold text-purple-700 mb-3">フォーム</h3>
                    <ul class="space-y-2">
                        <li><a href="https://docs.google.com/forms/d/e/1FAIpQLSe4KbW5mQQ-IkXeLNCWCMlkHDpdLkCkay08A6X1EvFbjNoEYg/viewform?usp=header" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline flex items-center">HPの改善点<span class="ml-1 text-xs">↗</span></a></li>
                        <li><a href="https://docs.google.com/forms/d/e/1FAIpQLSedhvF_EvlkiKNTw5-Rfg9Jsf5b7KGas9hEtRhIVZygbkS40A/viewform?usp=header" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline flex items-center">外国人に向けたアンケート<span class="ml-1 text-xs">↗</span></a></li>
                    </ul>
                </div>
                <!-- ドライブ -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-xl font-semibold text-red-700 mb-3">ドライブ</h3>
                    <ul class="space-y-2">
                        <li><a href="https://drive.google.com/drive/folders/1V6d5EiszW-dLcywv0UvRTMjVaCGfoFqo" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline flex items-center">共有ドライブ(B07) <span class="ml-1 text-xs">↗</span></a></li>
                    </ul>
                </div>
                <!-- よく使いそうなサイト -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-xl font-semibold text-teal-700 mb-3">よく使いそうなサイト</h3>
                    <ul class="space-y-2">
                        <li><a href="https://mail.google.com/chat/u/0/#chat/space/AAQAquQBKsk" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline flex items-center">チャットツール <span class="ml-1 text-xs">↗</span></a></li>
                    </ul>
                </div>
                <!-- その他 -->
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-600 mb-3">その他</h3>
                    <ul class="space-y-2">
                         <li><a href="https://jnk4.org/JAPIAS-DBx/WebContest/myPage/?p=x17xi80375jt" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline flex items-center">今年度のスケジュール<span class="ml-1 text-xs">↗</span></a></li>
                         <li><a href="https://webcon.japias.jp/rule.html" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:underline flex items-center">webコンのルール<span class="ml-1 text-xs">↗</span></a></li>
                    </ul>
                </div>
            </div>
        </section>

    </main>
    
    <!-- Modal Backdrop -->
    <div id="event-modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40"></div>

    <!-- Event Modal -->
    <div id="event-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl w-11/12 max-w-md p-6 z-50">
        <h3 id="modal-title" class="text-2xl font-bold text-gray-900 mb-2">Event Title</h3>
        <p id="modal-date" class="text-sm text-gray-500 mb-4">Event Date</p>
        <div class="mb-4">
            <h4 class="font-semibold text-gray-700 mb-2">備考欄</h4>
            <p id="modal-remarks" class="text-gray-600 bg-gray-100 p-3 rounded-md min-h-[80px]">ここに備考が表示されます。</p>
        </div>
        <button id="modal-close-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
    </div>

<script type="module">
    // Firebase SDKのインポート
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Firebaseの初期化
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEMO", authDomain: "DEMO", projectId: "DEMO" };
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 匿名認証
    if (typeof __initial_auth_token !== 'undefined') {
        await signInWithCustomToken(auth, __initial_auth_token);
    } else {
        await signInAnonymously(auth);
    }
    
    // --- ToDoリスト機能 ---
    const todoInput = document.getElementById('todo-input');
    const addTodoBtn = document.getElementById('add-todo-btn');
    const todoList = document.getElementById('todo-list');
    const todoDueDate = document.getElementById('todo-duedate');
    const filterAssigneeSelect = document.getElementById('filter-assignee');
    const sortOrderSelect = document.getElementById('sort-order');
    const allAssigneeCheckbox = document.getElementById('all-assignees-checkbox');
    const memberCheckboxes = document.querySelectorAll('.assignee-member');
    
    const todoCollectionPath = `/artifacts/${appId}/public/data/todos`;
    const todoCollection = collection(db, todoCollectionPath);
    let unsubscribe; 

    // Checkbox logic for 'All' selection
    allAssigneeCheckbox.addEventListener('change', (e) => {
        memberCheckboxes.forEach(checkbox => {
            checkbox.checked = e.target.checked;
        });
    });

    memberCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const allChecked = [...memberCheckboxes].every(cb => cb.checked);
            allAssigneeCheckbox.checked = allChecked;
        });
    });

    // Add task function
    const addTodo = async () => {
        addTodoBtn.disabled = true;
        const taskText = todoInput.value.trim();
        const dueDate = todoDueDate.value;
        const selectedAssignees = [...memberCheckboxes]
            .filter(checkbox => checkbox.checked)
            .map(checkbox => checkbox.value);

        if (taskText) {
            try {
                await addDoc(todoCollection, {
                    text: taskText,
                    completed: false,
                    createdAt: serverTimestamp(),
                    assignee: selectedAssignees,
                    dueDate: dueDate || null
                });
                // Reset form
                todoInput.value = '';
                todoDueDate.value = '';
                allAssigneeCheckbox.checked = false;
                memberCheckboxes.forEach(cb => cb.checked = false);
            } catch (e) {
                console.error("Error adding document: ", e);
            } finally {
                addTodoBtn.disabled = false;
            }
        } else {
             addTodoBtn.disabled = false;
        }
    };
    
    addTodoBtn.addEventListener('click', addTodo);
    todoInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            addTodo();
        }
    });

    // Function to render a single ToDo item
    function createTodoElement(docId, docData) {
        const li = document.createElement('li');
        li.setAttribute('data-id', docId);
        li.className = 'flex items-center justify-between p-2 rounded-md hover:bg-gray-50 border-b';
        
        const leftDiv = document.createElement('div');
        leftDiv.className = 'flex items-center flex-grow min-w-0';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = docData.completed;
        checkbox.className = 'mr-3 h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer flex-shrink-0';
        checkbox.addEventListener('change', async () => {
            const docRef = doc(db, todoCollectionPath, docId);
            await updateDoc(docRef, { completed: checkbox.checked });
        });

        const textSpan = document.createElement('span');
        textSpan.textContent = docData.text;
        textSpan.className = 'truncate';
        
        leftDiv.appendChild(checkbox);
        leftDiv.appendChild(textSpan);

        const rightDiv = document.createElement('div');
        rightDiv.className = 'flex items-center gap-x-3 ml-4 flex-shrink-0';

        if (docData.assignee && Array.isArray(docData.assignee) && docData.assignee.length > 0) {
            const assigneeContainer = document.createElement('div');
            assigneeContainer.className = 'flex items-center flex-wrap gap-1';
            docData.assignee.forEach(name => {
                const assigneeSpan = document.createElement('span');
                assigneeSpan.textContent = name;
                assigneeSpan.className = 'bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full';
                assigneeContainer.appendChild(assigneeSpan);
            });
            rightDiv.appendChild(assigneeContainer);
        }

        if (docData.dueDate) {
            const dueDateSpan = document.createElement('span');
            const dueDate = new Date(docData.dueDate + 'T00:00:00');
            dueDateSpan.textContent = dueDate.toLocaleDateString('ja-JP');
            dueDateSpan.className = 'text-sm text-gray-500';
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (!docData.completed && dueDate < today) {
                dueDateSpan.classList.add('text-red-500', 'font-semibold');
            }
            rightDiv.appendChild(dueDateSpan);
        }

        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 hover:text-red-500"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`;
        deleteBtn.addEventListener('click', async () => {
            const docRef = doc(db, todoCollectionPath, docId);
            await deleteDoc(docRef);
        });
        rightDiv.appendChild(deleteBtn);
        
        if (docData.completed) {
            li.classList.add('completed');
        }
        
        li.appendChild(leftDiv);
        li.appendChild(rightDiv);
        
        todoList.appendChild(li);
    }
    
    // Firestore listener setup
    function setupTodoListener() {
        if (unsubscribe) unsubscribe();

        const selectedAssignee = filterAssigneeSelect.value;
        const sortValue = sortOrderSelect.value;
        let constraints = [];
        
        if (selectedAssignee && selectedAssignee !== "全員") {
            if (selectedAssignee === "") { 
                constraints.push(where("assignee", "==", []));
            } else {
                constraints.push(where("assignee", "array-contains", selectedAssignee));
            }
        }
        
        let sortField, sortDirection;
        switch (sortValue) {
            case 'dueDateAsc':
                sortField = 'dueDate'; sortDirection = 'asc'; break;
            case 'dueDateDesc':
                sortField = 'dueDate'; sortDirection = 'desc'; break;
            case 'asc':
                sortField = 'createdAt'; sortDirection = 'asc'; break;
            default:
                sortField = 'createdAt'; sortDirection = 'desc'; break;
        }
        // Firestore requires that the first orderBy field matches the field in the inequality filter if one exists.
        // However, we can have multiple orderBy clauses. Here, we prioritize the user's sort choice.
        // For due date sorting, we also add a secondary sort by createdAt to have a consistent order for items with the same due date.
        if (sortField === 'dueDate') {
            constraints.push(orderBy(sortField, sortDirection));
            constraints.push(orderBy('createdAt', 'desc'));
        } else {
             constraints.push(orderBy(sortField, sortDirection));
        }

        const q = query(todoCollection, ...constraints);
        unsubscribe = onSnapshot(q, (snapshot) => {
            todoList.innerHTML = '';
            snapshot.forEach((doc) => createTodoElement(doc.id, doc.data()));
        }, (error) => {
            console.error("Error fetching todos: ", error);
            todoList.innerHTML = `<li class="text-red-500 p-4">データの読み込みに失敗しました。並び替えに必要なデータベース設定が完了していない可能性があります。</li>`;
        });
    }

    filterAssigneeSelect.addEventListener('change', setupTodoListener);
    sortOrderSelect.addEventListener('change', setupTodoListener);
    
    setupTodoListener();

    // --- カレンダー機能 ---
    const calendarContainer = document.getElementById('calendar-scroll-container');
    const prevButton = document.getElementById('prev-month');
    const nextButton = document.getElementById('next-month');
    const holidays = [
        { year: 2025, month: 10, day: 3, name: '文化の日' },
        { year: 2025, month: 10, day: 24, name: '振替休日' },
        { year: 2026, month: 0, day: 1, name: '元日' },
        { year: 2026, month: 0, day: 12, name: '成人の日' },
        { year: 2026, month: 1, day: 11, name: '建国記念の日' },
        { year: 2026, month: 1, day: 23, name: '天皇誕生日' },
        { year: 2026, month: 2, day: 20, name: '春分の日' },
    ];
    const events = [
        { year: 2025, month: 9, day: 13, title: 'Web会議(4時頃〜)', type: 'high-priority', remarks: '参加必須です。会議用のリンクは直前に共有します。' },
        { year: 2025, month: 9, day: 25, title: '運動会', type: 'high-priority', remarks: '運動会' },
        { year: 2025, month: 10, day: 2, title: 'エコチル調査発表', type: 'important', remarks: '頑張りましょう。時間などは後日共有します' },
        { year: 2025, month: 10, day: 6, title: '芸術鑑賞会', type: 'high-priority', remarks: '場所：有明四季劇場　現地集合・解散。' },
        { year: 2025, month: 10, day: 8, title: '探求Day', type: 'important', remarks: 'モリヤは公欠' },
        { year: 2025, month: 11, day: 2, title: '後期中間考査', type: 'high-priority', remarks: '試験頑張ってね。' },
        { year: 2025, month: 11, day: 3, title: '後期中間考査', type: 'high-priority', remarks: '試験頑張ってね。' },
        { year: 2025, month: 11, day: 4, title: '後期中間考査', type: 'high-priority', remarks: '試験頑張ってね。' },
        { year: 2025, month: 11, day: 12, title: '合唱祭', type: 'high-priority', remarks: '合唱祭頑張ってね' },
        
        // Webコンテストのスケジュール
        { year: 2025, month: 9, day: 22, title: '提出申請の受付締切', type: 'contest', remarks: '厳守' },
        { year: 2025, month: 9, day: 30, title: 'ストリーミングサーバーオープン', type: 'contest', remarks: '11月20日まで' },
        { year: 2025, month: 9, day: 30, title: '作品・サイトプロフィール提出オープン', type: 'contest', remarks: '11月20日まで' },
        { year: 2025, month: 9, day: 31, title: '希望ドメイン名の登録オープン', type: 'contest', remarks: '11月13日まで' },
        { year: 2025, month: 10, day: 13, title: 'ドメイン名の登録締切', type: 'contest', remarks: '厳守' },
        { year: 2025, month: 10, day: 20, title: 'ストリーミングサーバーの利用クローズ', type: 'contest', remarks: '' },
        { year: 2025, month: 10, day: 20, title: '作品の提出締切', type: 'contest', remarks: '厳守' },
        { year: 2025, month: 11, day: 10, title: 'トップ50およびセミファイナリスト発表', type: 'contest', remarks: '予定' },
        { year: 2025, month: 11, day: 27, title: '改良した作品・サイトプロフィール再提出の締切', type: 'contest', remarks: '厳守' },
        { year: 2025, month: 11, day: 27, title: 'ベストドメインネーミング賞応募締切', type: 'contest', remarks: 'レポート提出' },
        { year: 2026, month: 0, day: 24, title: 'ベストクリエイティブ賞 作品提出締切', type: 'contest', remarks: 'CM動画部門' },
        { year: 2026, month: 0, day: 30, title: 'ベストクリエイティブ賞 の改良受付', type: 'contest', remarks: 'CM動画部門(未定)' },
        { year: 2026, month: 1, day: 5, title: 'ベストクリエイティブ賞 の作品提出締切(改良版)', type: 'contest', remarks: 'CM動画部門(未定)' },
        { year: 2026, month: 0, day: 13, title: 'ファイナリスト発表', type: 'contest', remarks: '' },
        { year: 2026, month: 1, day: 18, title: 'プレゼン資料提出締切', type: 'contest', remarks: '厳守' },
        { year: 2026, month: 1, day: 21, title: 'ファイナリストプレゼンテーション', type: 'contest', remarks: 'プレゼン審査および授賞式' },
        { year: 2026, month: 1, day: 21, title: '最終結果発表', type: 'contest', remarks: '授賞式' },
    ];
    const startDate = new Date(2025, 9, 1);
    const endDate = new Date(2026, 2, 1);

    function createMonthCalendar(year, month) {
        const monthDiv = document.createElement('div');
        monthDiv.className = 'calendar-month flex-shrink-0 w-full p-2';
        const monthName = new Date(year, month).toLocaleString('ja-JP', { year: 'numeric', month: 'long' });
        let html = `<div class="text-center mb-4"><h3 class="text-xl font-semibold">${monthName}</h3></div>`;
        html += '<table class="w-full text-sm text-center border-collapse table-fixed">';
        html += '<thead><tr class="text-gray-600">';
        const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
        weekdays.forEach((day, i) => {
            let colorClass = '';
            if (i === 0) colorClass = 'text-red-500';
            if (i === 6) colorClass = 'text-blue-500';
            html += `<th class="p-2 w-1/7 border-b ${colorClass}">${day}</th>`;
        });
        html += '</tr></thead><tbody>';
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        let date = 1;
        for (let i = 0; i < 6; i++) {
            html += '<tr>';
            for (let j = 0; j < 7; j++) {
                if (i === 0 && j < firstDay || date > daysInMonth) {
                    html += '<td class="border p-1"></td>';
                } else {
                    const currentDate = new Date(year, month, date);
                    currentDate.setHours(0, 0, 0, 0);
                    let tdClass = '', dateDivClass = '', dateTextClass = '', holidayName = '';
                    const isPast = currentDate < today;
                    const isToday = currentDate.getTime() === today.getTime();
                    const dayOfWeek = currentDate.getDay();
                    const holiday = holidays.find(h => h.year === year && h.month === month && h.day === date);
                    const isSportsDay = year === 2025 && month === 9 && date === 13;
                    const isHoliday = holiday || isSportsDay;

                    if (holiday) {
                        const holidayTextColor = isPast ? 'text-gray-400' : 'text-red-700';
                        holidayName = `<div class="text-xs ${holidayTextColor} truncate">${holiday.name}</div>`;
                    } else if (isSportsDay) {
                        const holidayTextColor = isPast ? 'text-gray-400' : 'text-red-700';
                        holidayName = `<div class="text-xs ${holidayTextColor} truncate">スポーツの日</div>`;
                    }
                    
                    if (isHoliday) tdClass = 'bg-red-100';
                    else if (dayOfWeek === 0) tdClass = 'bg-red-100';
                    else if (dayOfWeek === 6) tdClass = 'bg-blue-100';

                    if (isPast) {
                        tdClass += ' past-day';
                        dateTextClass = 'text-gray-400';
                    } else {
                        if (isHoliday) dateTextClass = 'text-red-700';
                        else if (dayOfWeek === 0) dateTextClass = 'text-red-500';
                        else if (dayOfWeek === 6) dateTextClass = 'text-blue-500';
                        else dateTextClass = 'text-gray-800';
                    }

                    if (isToday) {
                        dateDivClass = 'bg-indigo-600 rounded-full';
                        dateTextClass = 'text-white font-bold';
                    }
                    
                    const dayEvents = events.filter(e => e.year === year && e.month === month && e.day === date);
                    const isNotNov8th = !(year === 2025 && month === 10 && date === 8);
                    const isNotOct25th = !(year === 2025 && month === 9 && date === 25);
                    if (dayOfWeek === 6 && isNotNov8th && isNotOct25th) {
                        dayEvents.push({ title: 'Worldday', type: 'saturday', remarks: '定例のWorlddayです。' });
                    }
                    let eventHtml = dayEvents.map(e => {
                        let eventClass = '';
                        switch(e.type) {
                            case 'important': eventClass = 'event-important'; break;
                            case 'high-priority': eventClass = 'event-high-priority'; break;
                            case 'saturday': eventClass = 'event-saturday'; break;
                            case 'contest': eventClass = 'event-contest'; break;
                            default: eventClass = 'event-normal';
                        }
                        const remarks = e.remarks || '';
                        return `<div class="event ${eventClass}" 
                                     title="${e.title}" 
                                     data-title="${e.title}"
                                     data-year="${year}"
                                     data-month="${month}"
                                     data-date="${date}"
                                     data-remarks="${remarks}"
                                     >${e.title}</div>`;
                    }).join('');
                    html += `<td class="border p-1 h-24 align-top ${tdClass.trim()}">
                                <div class="w-7 h-7 mx-auto flex items-center justify-center ${dateDivClass}">
                                    <span class="font-medium ${dateTextClass}">${date}</span>
                                </div>
                                ${holidayName}
                                ${eventHtml}
                             </td>`;
                    date++;
                }
            }
            html += '</tr>';
            if (date > daysInMonth) break;
        }
        html += '</tbody></table>';
        monthDiv.innerHTML = html;
        return monthDiv;
    }

    let calDate = new Date(startDate);
    while (calDate <= endDate) {
        const monthCalendar = createMonthCalendar(calDate.getFullYear(), calDate.getMonth());
        calendarContainer.appendChild(monthCalendar);
        calDate.setMonth(calDate.getMonth() + 1);
    }
    const scrollMonth = () => calendarContainer.querySelector('.calendar-month').offsetWidth;
    nextButton.addEventListener('click', () => calendarContainer.scrollBy({ left: scrollMonth(), behavior: 'smooth' }));
    prevButton.addEventListener('click', () => calendarContainer.scrollBy({ left: -scrollMonth(), behavior: 'smooth' }));

    // --- Modal Logic ---
    const modal = document.getElementById('event-modal');
    const backdrop = document.getElementById('event-modal-backdrop');
    const modalTitle = document.getElementById('modal-title');
    const modalDate = document.getElementById('modal-date');
    const modalRemarks = document.getElementById('modal-remarks');
    const closeModalBtn = document.getElementById('modal-close-btn');

    calendarContainer.addEventListener('click', function(e) {
        const eventEl = e.target.closest('.event');
        if (eventEl) {
            const title = eventEl.dataset.title;
            const year = parseInt(eventEl.dataset.year);
            const month = parseInt(eventEl.dataset.month);
            const day = parseInt(eventEl.dataset.date);
            const remarks = eventEl.dataset.remarks;

            modalTitle.textContent = title;
            modalDate.textContent = `${year}年${month + 1}月${day}日`;
            modalRemarks.textContent = remarks || '特にありません。';

            modal.classList.remove('hidden');
            backdrop.classList.remove('hidden');
        }
    });

    function closeModal() {
        modal.classList.add('hidden');
        backdrop.classList.add('hidden');
    }

    closeModalBtn.addEventListener('click', closeModal);
    backdrop.addEventListener('click', closeModal);
</script>
</body>
</html>

